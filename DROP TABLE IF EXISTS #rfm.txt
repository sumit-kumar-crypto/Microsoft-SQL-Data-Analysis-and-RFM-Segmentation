DROP TABLE IF EXISTS #rfm
;with rfm as 
(select
CUSTOMERNAME,
SUM(SALES) AS Monetary_Value,
AVG(SALES) AS Avg_Monetary_Value,
COUNT(ORDERNUMBER) AS FREQUENCY,
MAX(ORDERDATE)  as LAST_ORDER_DATE,
(SELECT MAX(ORDERDATE) FROM sales_data_sample) as MAX_ORDER_DATE,
DATEDIFF(DD,MAX(ORDERDATE),(SELECT MAX(ORDERDATE) FROM sales_data_sample)) AS RECENCY
FROM sales_data_sample
GROUP BY CUSTOMERNAME
),

rfm_calc as
(select r.*,
NTILE(4) OVER (ORDER BY RECENCY DESC) AS RFM_RECENCY,
NTILE(4) OVER (ORDER BY FREQUENCY DESC) AS RFM_FREQUENCY,
NTILE(4) OVER (ORDER BY Monetary_Value DESC) AS RFM_MONETARY
FROM rfm as r
)

select c.*,RFM_RECENCY + RFM_FREQUENCY + RFM_MONETARY AS RFM_CELL,
CAST(RFM_RECENCY AS VARCHAR) + CAST(RFM_FREQUENCY AS VARCHAR) + CAST(RFM_MONETARY AS VARCHAR) AS RFM_CELL_STRING
INTO # rfm
from rfm_calc as c

select CUSTOMERNAME,RFM_RECENCY,RFM_FREQUENCY,RFM_MONETARY

case 
    when RFM_CELL_STRING IN (111,112,121,122,123,132,211,212,114,141) THEN 'CUSTOMER_LOST'
	when RFM_CELL_STRING IN (134,133,143,244,334,343,344) THEN 'SLIPPING AWAY CUSTOMERS'
	when RFM_CELL_STRING IN (311,411,331) THEN 'NEW CUSTOMER'
	when RFM_CELL_STRING IN (222,223,233,322) THEN 'POTENTIAL CUSTOMERS'
	when RFM_CELL_STRING IN (323,333,321,422,332,432) THEN 'ACTIVE CUSTOMER'
	when RFM_CELL_STRING IN (433,434,443,444) THEN 'LOYAL CUSTOMER'
END rfm_segment
FROM #rfm